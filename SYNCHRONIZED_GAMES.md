# Synchronized Games Implementation

This document describes the implementation of automatic, synchronized games for Roulette and Crash with provably fair results.

## Features

### ✅ Automatic Rounds
- Games run automatically on a schedule
- All users see the same rounds simultaneously
- No user interaction needed to start rounds

### ✅ Provably Fair
- Server generates a seed and hash before each round
- Results are deterministically calculated from seeds
- Users can verify fairness after rounds complete
- Admins can predict results (for transparency)

### ✅ History Tracking
- All rounds are stored in the database
- Users can see recent history
- Admins can view full history

### ✅ Admin Predictions
- Admins can see predicted results before rounds finish
- Helps verify the system is working correctly
- Useful for debugging and transparency

## Database Schema

### Tables Created
- `roulette_rounds`: Stores roulette round information
- `crash_rounds`: Stores crash round information
- `roulette_bets`: Stores user bets for roulette rounds
- `crash_bets`: Stores user bets for crash rounds

### Key Fields
- `server_seed`: Random seed generated by server
- `server_seed_hash`: SHA256 hash of seed (shown to users)
- `client_seed`: Optional client seed (for enhanced fairness)
- `result_number` / `crash_point`: The actual result
- `status`: Current round status (betting, spinning/running, finished)

## API Endpoints

### Roulette
- `getRouletteRound`: Get current round state
- `placeRouletteBet`: Place a bet on current round
- `getRouletteHistory`: Get recent round history

### Crash
- `getCrashRound`: Get current round state
- `placeCrashBet`: Place a bet on current round
- `cashOutCrash`: Cash out during a running round
- `getCrashHistory`: Get recent round history

### Admin
- `getRouletteRoundAdmin`: Get round with predicted result
- `getCrashRoundAdmin`: Get round with predicted crash point

## Client-Side Changes

### Roulette (`js/roulette.js`)
- Polls server every 2 seconds for round state
- Displays betting countdown
- Shows synchronized spinning animation
- Displays results when round finishes

### Crash (`js/crash.js`)
- Polls server every 2 seconds for round state
- Displays betting countdown
- Animates multiplier rising
- Handles cash-out during round
- Shows crash point when round finishes

## Worker Script

The `workers/game_rounds_worker.php` script manages rounds:
- Creates new rounds automatically
- Transitions rounds between states
- Calculates results using provably fair system
- Processes bets and distributes winnings

### Running the Worker

See `workers/README.md` for detailed setup instructions.

Quick start:
```bash
# Option 1: Cron (every 2 seconds)
* * * * * for i in {0..29}; do php /path/to/workers/game_rounds_worker.php; sleep 2; done

# Option 2: Background process
nohup php workers/game_rounds_worker.php > /dev/null 2>&1 &
```

## Configuration

Settings can be changed in the admin panel:

- `roulette_betting_duration`: 15 seconds (default)
- `roulette_spinning_duration`: 4 seconds (default)
- `roulette_round_interval`: 5 seconds (default)
- `crash_betting_duration`: 15 seconds (default)
- `crash_round_interval`: 5 seconds (default)

## How Provably Fair Works

1. **Before Round**: Server generates random seed and calculates hash
2. **During Betting**: Hash is shown to users (they can't see the seed)
3. **After Round**: Server reveals the seed, users can verify:
   - Hash matches the seed
   - Result matches the calculated result from seed
4. **Admin View**: Admins can see the seed and predict results

## Round Lifecycle

### Roulette
1. **Betting** (15s): Users place bets
2. **Spinning** (4s): Wheel spins, result is calculated
3. **Finished**: Results shown, bets processed

### Crash
1. **Betting** (15s): Users place bets
2. **Running** (until crash): Multiplier rises, users can cash out
3. **Finished**: Crash point reached, bets processed

## Testing

1. Start the worker script
2. Open roulette/crash game pages
3. Wait for betting phase
4. Place bets
5. Watch round execute
6. Verify results match admin predictions

## Troubleshooting

- **Rounds not starting**: Check worker is running
- **Results don't match**: Verify provably fair calculation
- **Bets not processing**: Check database permissions
- **Client not syncing**: Check API endpoints are accessible
